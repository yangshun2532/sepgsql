--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS f1(int) CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
-- SETUP
CREATE TABLE t1
(
    a   int,
    b   text
        SECURITY_CONTEXT = 'unconfined_u:object_r:sepgsql_ro_table_t:s0',
    c   bool
        SECURITY_CONTEXT = 'unconfined_u:object_r:sepgsql_secret_table_t:s0'
);
CREATE TABLE
INSERT INTO t1 VALUES (1, 'aaa', false), (2, 'bbb', true);
INSERT 0 2
CREATE TABLE t2
(
    s   int,
    t   int,
    u   int
) SECURITY_CONTEXT = 'unconfined_u:object_r:sepgsql_table_t:s0:c0';
CREATE TABLE
ALTER TABLE t2 DROP COLUMN t;	-- disturbing factor
ALTER TABLE
CREATE TABLE t3
(
    x   text
        SECURITY_CONTEXT = 'unconfined_u:object_r:sepgsql_table_t:s0:c1'
) inherits(t2);
CREATE TABLE
--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

SELECT * FROM t1;			-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t1.c
SELECT a, b FROM t1;
 a |  b  
---+-----
 1 | aaa
 2 | bbb
(2 rows)

SELECT COUNT(*) FROM t1 WHERE c;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t1.c
UPDATE t1 SET b = 'ccc';		-- to be denied
ERROR:  SELinux: denied { update } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:sepgsql_ro_table_t:s0 tclass=db_column name=t1.b
UPDATE t1 SET a = a + 2;
UPDATE 2
INSERT INTO t1 VALUES (5, 'eee', true);	-- to be denied
ERROR:  SELinux: denied { insert } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:sepgsql_ro_table_t:s0 tclass=db_column name=t1.b
INSERT INTO t1 VALUES (5);
INSERT 0 1
SELECT * FROM t2;
 s | u 
---+---
(0 rows)

SELECT t2 FROM t2;
 t2 
----
(0 rows)

SELECT t3 FROM t3;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:sepgsql_table_t:s0:c1 tclass=db_column name=t3.x
SELECT 1 FROM t3;
 ?column? 
----------
(0 rows)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1
(1 row)

SELECT * FROM t2;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1 tcontext=unconfined_u:object_r:sepgsql_table_t:s0:c0 tclass=db_table name=t2
SELECT t2 FROM t2;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1 tcontext=unconfined_u:object_r:sepgsql_table_t:s0:c0 tclass=db_table name=t2
SELECT t3 FROM t3;
 t3 
----
(0 rows)

