--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS f1(int) CASCADE;
DROP FUNCTION
DROP FUNCTION IF EXISTS f2(int) CASCADE;
DROP FUNCTION
DROP FUNCTION IF EXISTS f3() CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
-- SETUP
CREATE TABLE t1
(
    a   int,
    b   text
);
CREATE TABLE
CREATE TABLE t2
(
    x   int,
    y   text
        SECURITY_LABEL = 'system_u:object_r:sepgsql_secret_table_t:s0'
);
CREATE TABLE
CREATE TABLE t3
(
    uid     int,
    uname   text,
    ucredit text
            SECURITY_LABEL = 'system_u:object_r:sepgsql_secret_table_t:s0'
);
CREATE TABLE
INSERT INTO t1 VALUES (1, 'aaa'), (2, 'bbb'), (3, 'ccc');
INSERT 0 3
INSERT INTO t2 VALUES (7, 'xxx'), (8, 'yyy'), (9, 'zzz');
INSERT 0 3
INSERT INTO t3 VALUES (10, 'red',   '1111-2222-3333'),
                      (11, 'blue',  '4444-5555-6666'),
                      (12, 'green', '7777-8888-9999');
INSERT 0 3
CREATE OR REPLACE FUNCTION f1 (int) RETURNS int
    LANGUAGE 'sql'
    SECURITY_LABEL = 'system_u:object_r:user_sepgsql_proc_exec_t:s0'
    AS 'SELECT $1 + $1';
CREATE FUNCTION
CREATE OR REPLACE FUNCTION f2 (int) RETURNS text
    LANGUAGE 'sql'
    SECURITY_LABEL = 'system_u:object_r:sepgsql_trusted_proc_exec_t:s0'
    AS 'SELECT regexp_replace(ucredit, ''-[0-9]+'', ''-xxxx'', ''g'') FROM t3 WHERE uid = $1';
CREATE FUNCTION
CREATE OR REPLACE FUNCTION f3() RETURNS trigger
    LANGUAGE 'plpgsql'
    AS 'BEGIN RAISE INFO ''OLD TUPLE: %'', OLD; RETURN NEW; end';
CREATE FUNCTION
CREATE TRIGGER tg1 BEFORE UPDATE OR DELETE ON t1
    FOR EACH ROW EXECUTE PROCEDURE f3();
CREATE TRIGGER
CREATE TRIGGER tg2 BEFORE UPDATE OR DELETE ON t2
    FOR EACH ROW EXECUTE PROCEDURE f3();
CREATE TRIGGER
-- TEST
SELECT f1(3);	-- to be denied
NOTICE:  SELinux: denied { execute } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=system_u:object_r:user_sepgsql_proc_exec_t:s0 tclass=db_procedure name=f1
NOTICE:  SELinux: denied { execute } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=system_u:object_r:user_sepgsql_proc_exec_t:s0 tclass=db_procedure name=f1
ERROR:  permission denied for function f1
ALTER FUNCTION f1(int)
    SECURITY_LABEL = 'system_u:object_r:sepgsql_proc_t:s0';
ALTER FUNCTION
SELECT f1(6);
 f1 
----
 12
(1 row)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

SELECT * FROM t1;
 a |  b  
---+-----
 1 | aaa
 2 | bbb
 3 | ccc
(3 rows)

SELECT * FROM t2;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.y
SELECT x FROM t2;
 x 
---
 7
 8
 9
(3 rows)

UPDATE t1 SET a = a;
INFO:  OLD TUPLE: (1,aaa)
INFO:  OLD TUPLE: (2,bbb)
INFO:  OLD TUPLE: (3,ccc)
UPDATE 3
UPDATE t2 SET x = x;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.y
INSERT INTO t1 VALUES (99, 'XXX');
INSERT 0 1
INSERT INTO t2 VALUES (98, 'YYY');	-- to be denied
ERROR:  SELinux: denied { insert } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.y
INSERT INTO t2 VALUES (97);
INSERT 0 1
DELETE FROM t1 WHERE a > 10;
INFO:  OLD TUPLE: (99,XXX)
DELETE 0
DELETE FROM t2 WHERE x > 10;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.y
SELECT * FROM t3;	-- to be denied
ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t3.ucredit
SELECT uid, uname FROM t3;
 uid | uname 
-----+-------
  10 | red
  11 | blue
  12 | green
(3 rows)

SELECT uid, uname, f2(uid) FROM t3;
 uid | uname |       f2       
-----+-------+----------------
  10 | red   | 1111-xxxx-xxxx
  11 | blue  | 4444-xxxx-xxxx
  12 | green | 7777-xxxx-xxxx
(3 rows)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

DROP TRIGGER IF EXISTS tg2 ON t2;
DROP TRIGGER
--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

UPDATE t2 SET x = x;
UPDATE 4
INSERT INTO t2 VALUES (98, 'YYY');	-- to be denied
ERROR:  SELinux: denied { insert } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.y
DELETE FROM t2 WHERE x > 10;
DELETE 1
