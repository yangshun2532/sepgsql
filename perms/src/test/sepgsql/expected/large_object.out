--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS lolabel CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS lo_label(oid) CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
CREATE TABLE lolabel(
       loid	oid,
       label	text
);
CREATE TABLE
CREATE OR REPLACE FUNCTION lo_label(oid)
       RETURNS TEXT LANGUAGE 'sql'
       AS 'SELECT label FROM lolabel WHERE loid = $1';
CREATE FUNCTION
INSERT INTO lolabel (SELECT lo_import('/tmp/sepgsql_test_blob1'), 'normal');
INSERT 0 1
INSERT INTO lolabel (SELECT lo_import('/tmp/sepgsql_test_blob1'), 'readonly');
INSERT 0 1
INSERT INTO lolabel (SELECT lo_import('/tmp/sepgsql_test_blob1'), 'secret');
INSERT 0 1
SELECT lo_set_security(loid, 'system_u:object_r:sepgsql_blob_t:s0')
       FROM lolabel WHERE label = 'normal';
 lo_set_security 
-----------------
 t
(1 row)

SELECT lo_set_security(loid, 'system_u:object_r:sepgsql_ro_blob_t:s0')
       FROM lolabel WHERE label = 'readonly';
 lo_set_security 
-----------------
 t
(1 row)

SELECT lo_set_security(loid, 'system_u:object_r:sepgsql_secret_blob_t:s0')
       FROM lolabel WHERE label = 'secret';
 lo_set_security 
-----------------
 t
(1 row)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0:c0
SELECT sepgsql_getcon();
                 sepgsql_getcon                 
------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0:c0
(1 row)

SELECT lo_get_security(loid) FROM lolabel;
              lo_get_security               
--------------------------------------------
 system_u:object_r:sepgsql_blob_t:s0
 system_u:object_r:sepgsql_ro_blob_t:s0
 system_u:object_r:sepgsql_secret_blob_t:s0
(3 rows)

SELECT security_label, lo_label(loid) AS label, COUNT(*)
       FROM pg_largeobject GROUP BY security_label, loid ORDER by label;
               security_label               |  label   | count 
--------------------------------------------+----------+-------
 system_u:object_r:sepgsql_blob_t:s0        | normal   |    10
 system_u:object_r:sepgsql_ro_blob_t:s0     | readonly |    10
 system_u:object_r:sepgsql_secret_blob_t:s0 | secret   |    10
(3 rows)

-- read large object
BEGIN;
BEGIN
SELECT lo_open(loid, x'40000'::int) FROM lolabel WHERE label = 'normal';
 lo_open 
---------
       0
(1 row)

SELECT loread(0, 32);
                                                              loread                                                              
----------------------------------------------------------------------------------------------------------------------------------
 \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000
(1 row)

ROLLBACK;
ROLLBACK
BEGIN;
BEGIN
SELECT lo_open(loid, x'40000'::int) FROM lolabel WHERE label = 'readonly';
 lo_open 
---------
       0
(1 row)

SELECT loread(0, 32);
                                                              loread                                                              
----------------------------------------------------------------------------------------------------------------------------------
 \000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000
(1 row)

ROLLBACK;
ROLLBACK
BEGIN;
BEGIN
SELECT lo_open(loid, x'40000'::int) FROM lolabel WHERE label = 'secret';
 lo_open 
---------
       0
(1 row)

SELECT loread(0, 32);           -- to be denied
ERROR:  SELinux: denied { read } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0:c0 tcontext=system_u:object_r:sepgsql_secret_blob_t:s0 tclass=db_blob
ROLLBACK;
ROLLBACK
-- write large object
BEGIN;
BEGIN
SELECT lo_open(loid, x'20000'::int) FROM lolabel WHERE label = 'normal';
 lo_open 
---------
       0
(1 row)

SELECT lowrite(0, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ');
 lowrite 
---------
      26
(1 row)

ROLLBACK;
ROLLBACK
BEGIN;
BEGIN
SELECT lo_open(loid, x'20000'::int) FROM lolabel WHERE label = 'readonly';
 lo_open 
---------
       0
(1 row)

SELECT lowrite(0, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ');        -- to be denied
ERROR:  SELinux: denied { write } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0:c0 tcontext=system_u:object_r:sepgsql_ro_blob_t:s0 tclass=db_blob
ROLLBACK;
ROLLBACK
BEGIN;
BEGIN
SELECT lo_open(loid, x'20000'::int) FROM lolabel WHERE label = 'secret';
 lo_open 
---------
       0
(1 row)

SELECT lowrite(0, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ');        -- to be denied
ERROR:  SELinux: denied { write } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0:c0 tcontext=system_u:object_r:sepgsql_secret_blob_t:s0 tclass=db_blob
ROLLBACK;
ROLLBACK
-- create large object
BEGIN;
BEGIN
INSERT INTO lolabel (SELECT lo_create(6004), 'local');
INSERT 0 1
SELECT lo_open(loid, x'20000'::int) FROM lolabel WHERE label = 'local';
 lo_open 
---------
       0
(1 row)

SELECT lowrite(0, 'abcdefghijklmnopqrstuvwxyz');
 lowrite 
---------
      26
(1 row)

SELECT lo_close(0);
 lo_close 
----------
        0
(1 row)

COMMIT;
COMMIT
-- getattr/setattr
BEGIN;
BEGIN
SELECT lo_open(loid, x'20000'::int) FROM lolabel WHERE label = 'local';
 lo_open 
---------
       0
(1 row)

SELECT lo_lseek(0, 0, 2);	-- seek to end
 lo_lseek 
----------
       26
(1 row)

SELECT lowrite(0, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ');
 lowrite 
---------
      26
(1 row)

SELECT lo_tell(0);
 lo_tell 
---------
      52
(1 row)

SELECT lo_lseek(0, 0, 0);	-- seek to head
 lo_lseek 
----------
        0
(1 row)

SELECT loread(0, 50);
                       loread                       
----------------------------------------------------
 abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWX
(1 row)

SELECT lo_close(0);
 lo_close 
----------
        0
(1 row)

COMMIT;
COMMIT
--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- change security label
BEGIN;
BEGIN
SELECT lo_open(loid, x'40000'::int) FROM lolabel;    -- a seed of trouble
 lo_open 
---------
       0
       1
       2
       3
(4 rows)

SELECT lo_set_security(loid, 'system_u:object_r:sepgsql_blob_t:s0:c4')
	FROM lolabel WHERE label in ('normal', 'readonly');
 lo_set_security 
-----------------
 t
 t
(2 rows)

SELECT lo_get_security(loid) FROM lolabel;
                     lo_get_security                     
---------------------------------------------------------
 system_u:object_r:sepgsql_blob_t:s0:c4
 system_u:object_r:sepgsql_blob_t:s0:c4
 system_u:object_r:sepgsql_secret_blob_t:s0
 unconfined_u:object_r:sepgsql_test_sepgsql_blob_t:s0:c0
(4 rows)

SELECT security_label, lo_label(loid) AS label, count(*)
	FROM pg_largeobject WHERE loid in (SELECT loid FROM lolabel)
	GROUP BY security_label, loid ORDER BY label;
                     security_label                      |  label   | count 
---------------------------------------------------------+----------+-------
 unconfined_u:object_r:sepgsql_test_sepgsql_blob_t:s0:c0 | local    |     1
 system_u:object_r:sepgsql_blob_t:s0:c4                  | normal   |    10
 system_u:object_r:sepgsql_blob_t:s0:c4                  | readonly |    10
 system_u:object_r:sepgsql_secret_blob_t:s0              | secret   |    10
(4 rows)

ROLLBACK;
ROLLBACK
-- cleanup
SELECT lo_unlink(loid) FROM lolabel;
 lo_unlink 
-----------
         1
         1
         1
         1
(4 rows)

