-- Basic security_label management
-- ===============================
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE IF EXISTS t1 CASCADE;
RESET client_min_messages;
-- test proper begins here
CREATE TABLE t1
(
	a	int,
	b	text
);
CREATE TABLE t2
(
	x	int,
	y	text
);
INSERT INTO t1 VALUES (1, 'aaa'), (2, 'bbb');
INSERT INTO t1 (security_label, a, b) VALUES ('system_u:object_r:sepgsql_ro_table_t:s0', 3, 'ccc');
INSERT INTO t1 (security_label, a, b)
       (SELECT sepgsql_set_range(security_label, 's0:c' || a) AS security_label, a+3 AS a, b || '_ins' AS b FROM t1);
INSERT INTO t1 (security_label, a, b) VALUES ('invalid label', 99, 'zzz');	-- to be failed
psql:sql/security_label_sysattr.init:33: ERROR:  PGACE: invalid security label: invalid label
INSERT INTO t1 (security_label, a, b) VALUES ('system_u:object_r:sepgsql_table_t:s0:c99', 99, 'zzz');	-- to be failed
SELECT security_label, * FROM t1;
               security_label                | a |    b    
---------------------------------------------+---+---------
 unconfined_u:object_r:sepgsql_table_t:s0    | 1 | aaa
 unconfined_u:object_r:sepgsql_table_t:s0    | 2 | bbb
 system_u:object_r:sepgsql_ro_table_t:s0     | 3 | ccc
 unconfined_u:object_r:sepgsql_table_t:s0:c1 | 4 | aaa_ins
 unconfined_u:object_r:sepgsql_table_t:s0:c2 | 5 | bbb_ins
 system_u:object_r:sepgsql_ro_table_t:s0:c3  | 6 | ccc_ins
(6 rows)

INSERT INTO t2 (security_label, x, y) (SELECT security_label, a * 2, security_label || '_ins' FROM t1);
SELECT security_label, * FROM t2;
               security_label                | x  |                        y                        
---------------------------------------------+----+-------------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0    |  2 | unconfined_u:object_r:sepgsql_table_t:s0_ins
 unconfined_u:object_r:sepgsql_table_t:s0    |  4 | unconfined_u:object_r:sepgsql_table_t:s0_ins
 system_u:object_r:sepgsql_ro_table_t:s0     |  6 | system_u:object_r:sepgsql_ro_table_t:s0_ins
 unconfined_u:object_r:sepgsql_table_t:s0:c1 |  8 | unconfined_u:object_r:sepgsql_table_t:s0:c1_ins
 unconfined_u:object_r:sepgsql_table_t:s0:c2 | 10 | unconfined_u:object_r:sepgsql_table_t:s0:c2_ins
 system_u:object_r:sepgsql_ro_table_t:s0:c3  | 12 | system_u:object_r:sepgsql_ro_table_t:s0:c3_ins
(6 rows)

UPDATE t1 SET security_label = sepgsql_set_range(security_label, 's0:c' || a);
SELECT security_label, * FROM t1;
               security_label                | a |    b    
---------------------------------------------+---+---------
 unconfined_u:object_r:sepgsql_table_t:s0:c1 | 1 | aaa
 unconfined_u:object_r:sepgsql_table_t:s0:c2 | 2 | bbb
 system_u:object_r:sepgsql_ro_table_t:s0:c3  | 3 | ccc
 unconfined_u:object_r:sepgsql_table_t:s0:c4 | 4 | aaa_ins
 unconfined_u:object_r:sepgsql_table_t:s0:c5 | 5 | bbb_ins
 system_u:object_r:sepgsql_ro_table_t:s0:c6  | 6 | ccc_ins
(6 rows)

UPDATE t1 SET security_label = sepgsql_set_type(security_label, 'sepgsql_ro_t') WHERE a IN (1,3,5);
psql:sql/security_label_sysattr.init:42: ERROR:  PGACE: invalid security label: unconfined_u:object_r:sepgsql_ro_t:s0:c1
UPDATE t1 SET security_label = sepgsql_set_range(security_label, 's0:c' || (a+11));	-- partial success
psql:sql/security_label_sysattr.init:44: NOTICE:  SELinux: denied { relabelto } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=unconfined_u:object_r:sepgsql_table_t:s0:c16 tclass=db_tuple
psql:sql/security_label_sysattr.init:44: NOTICE:  SELinux: denied { relabelto } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=system_u:object_r:sepgsql_ro_table_t:s0:c17 tclass=db_tuple
SELECT security_label, * FROM t1;
                security_label                | a |    b    
----------------------------------------------+---+---------
 unconfined_u:object_r:sepgsql_table_t:s0:c5  | 5 | bbb_ins
 system_u:object_r:sepgsql_ro_table_t:s0:c6   | 6 | ccc_ins
 unconfined_u:object_r:sepgsql_table_t:s0:c12 | 1 | aaa
 unconfined_u:object_r:sepgsql_table_t:s0:c13 | 2 | bbb
 system_u:object_r:sepgsql_ro_table_t:s0:c14  | 3 | ccc
 unconfined_u:object_r:sepgsql_table_t:s0:c15 | 4 | aaa_ins
(6 rows)

UPDATE t1 SET security_label = 'invalid label';	-- to be failed
psql:sql/security_label_sysattr.init:46: ERROR:  PGACE: invalid security label: invalid label
SELECT security_label, a+10 AS a, b || '_t3' INTO t3 FROM t1;
SELECT security_label, * FROM t3;
                security_label                | a  |  ?column?  
----------------------------------------------+----+------------
 unconfined_u:object_r:sepgsql_table_t:s0:c5  | 15 | bbb_ins_t3
 system_u:object_r:sepgsql_ro_table_t:s0:c6   | 16 | ccc_ins_t3
 unconfined_u:object_r:sepgsql_table_t:s0:c12 | 11 | aaa_t3
 unconfined_u:object_r:sepgsql_table_t:s0:c13 | 12 | bbb_t3
 system_u:object_r:sepgsql_ro_table_t:s0:c14  | 13 | ccc_t3
 unconfined_u:object_r:sepgsql_table_t:s0:c15 | 14 | aaa_ins_t3
(6 rows)

SELECT a+20 AS a, b || '_t4' INTO t4 FROM t1;
SELECT security_label, * FROM t4;
              security_label              | a  |  ?column?  
------------------------------------------+----+------------
 unconfined_u:object_r:sepgsql_table_t:s0 | 25 | bbb_ins_t4
 unconfined_u:object_r:sepgsql_table_t:s0 | 26 | ccc_ins_t4
 unconfined_u:object_r:sepgsql_table_t:s0 | 21 | aaa_t4
 unconfined_u:object_r:sepgsql_table_t:s0 | 22 | bbb_t4
 unconfined_u:object_r:sepgsql_table_t:s0 | 23 | ccc_t4
 unconfined_u:object_r:sepgsql_table_t:s0 | 24 | aaa_ins_t4
(6 rows)

TRUNCATE t2;
COPY t2 (security_label, x, y) FROM stdin;
COPY t2 TO stdout;
1	aaa
2	bbb
3	ccc
COPY t2 (security_label, x, y) TO stdout;
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c1	2	bbb
system_u:object_r:sepgsql_table_t:s0:c2	3	ccc
COPY t2 (security_label, x, y) TO stdout CSV FORCE QUOTE security_label,y;
"system_u:object_r:sepgsql_table_t:s0",1,"aaa"
"system_u:object_r:sepgsql_table_t:s0:c1",2,"bbb"
"system_u:object_r:sepgsql_table_t:s0:c2",3,"ccc"
-- Basic security label
-- ====================
