--
-- Initial setup of SE-PostgreSQL testcases
--
-- selinux_user: unconfined_u
-- selinux_role: unconfined_r
-- selinux_type: unconfined_t
-- selinux_range: s0-s0:c0.c15
-- -------------------------------------------------------
-- Test B : Row-Level Access Control
-- -------------------------------------------------------
-- memo: to confirm default security context on INSERT
SELECT security_context, * FROM b1;
                 security_context                  | x  |       y       
---------------------------------------------------+----+---------------
 unconfined_u:object_r:sepgsql_table_t:s0:c1       |  4 | coffee
 unconfined_u:object_r:sepgsql_fixed_table_t:s0    |  2 | coke
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c1 |  3 | juice
 unconfined_u:object_r:sepgsql_table_t:s0          |  1 | water_updated
 unconfined_u:object_r:sepgsql_table_t:s0          |  5 | beer_updated
 unconfined_u:object_r:sepgsql_table_t:s0          |  6 | wine_updated
 unconfined_u:object_r:sepgsql_table_t:s0:c0       | 10 | soda
(7 rows)

SELECT security_context, * FROM b2;
                security_context                | a  |   b    
------------------------------------------------+----+--------
 unconfined_u:object_r:sepgsql_table_t:s0:c1    |  4 | yellow
 unconfined_u:object_r:sepgsql_ro_table_t:s0:c1 |  5 | black
 unconfined_u:object_r:sepgsql_ro_table_t:s0    |  6 | white
 unconfined_u:object_r:sepgsql_table_t:s0:c0    | 10 | orange
(4 rows)

DROP TABLE b1;
DROP TABLE b2;
-- -------------------------------------------------------
-- Test C : Column-Level Access Control
-- -------------------------------------------------------
DROP TABLE c1;
DROP TABLE c2;
-- -------------------------------------------------------
-- Test D : PK/FK constraint
-- -------------------------------------------------------
DROP TABLE d2;
DROP TABLE d1;
-- -------------------------------------------------------
-- Test E : Trusted Procedure
-- -------------------------------------------------------
DROP TABLE e1;
DROP FUNCTION e2(integer);
DROP FUNCTION e3();
-- -------------------------------------------------------
-- Test F : Large Object
-- -------------------------------------------------------
SELECT lo_unlink(6001);
 lo_unlink 
-----------
         1
(1 row)

SELECT lo_unlink(6002);
 lo_unlink 
-----------
         1
(1 row)

SELECT lo_unlink(6003);
 lo_unlink 
-----------
         1
(1 row)

SELECT lo_unlink(6004);
 lo_unlink 
-----------
         1
(1 row)

-- -------------------------------------------------------
-- Test G : Copy To/From
-- -------------------------------------------------------
COPY g1 (security_context, a, b) TO stdout;
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c0	2	bbb
system_u:object_r:sepgsql_table_t:s0	3	ccc
system_u:object_r:sepgsql_table_t:s0:c1	4	ddd
system_u:object_r:sepgsql_table_t:s0:c0	5	eee
system_u:object_r:sepgsql_table_t:s0	6	fff
system_u:object_r:sepgsql_table_t:s0:c1	7	ggg
unconfined_u:object_r:sepgsql_table_t:s0:c0	24	xxx
unconfined_u:object_r:sepgsql_table_t:s0:c0	25	yyy
COPY g2 (security_context, x, y, z) TO stdout;
unconfined_u:object_r:sepgsql_table_t:s0	1	aaa	AAA
unconfined_u:object_r:sepgsql_table_t:s0	2	bbb	BBB
unconfined_u:object_r:sepgsql_table_t:s0	3	ccc	CCC
unconfined_u:object_r:sepgsql_table_t:s0	4	ddd	DDD
unconfined_u:object_r:sepgsql_table_t:s0:c0	99	\N	\N
unconfined_u:object_r:sepgsql_table_t:s0:c0	98	\N	\N
unconfined_u:object_r:sepgsql_table_t:s0:c0	97	\N	\N
DROP TABLE g1;
DROP TABLE g2;
-- -------------------------------------------------------
-- Test H : Set Operations/With Recursive
-- -------------------------------------------------------
WITH RECURSIVE h9 AS
(
	SELECT security_context, * FROM h1 WHERE pid is NULL
	UNION ALL
	SELECT h1.security_context, h1.* FROM h1,h9 WHERE h1.pid = h9.id
)
SELECT * FROM h9;
            security_context             | id  | pid |  name  
-----------------------------------------+-----+-----+--------
 system_u:object_r:sepgsql_table_t:s0    |   0 |     | /
 system_u:object_r:sepgsql_table_t:s0    |   1 |   0 | /a
 system_u:object_r:sepgsql_table_t:s0:c1 |   2 |   0 | /b
 system_u:object_r:sepgsql_table_t:s0    |  11 |   1 | /a/a
 system_u:object_r:sepgsql_table_t:s0:c1 |  12 |   1 | /a/b
 system_u:object_r:sepgsql_table_t:s0    |  21 |   2 | /b/a
 system_u:object_r:sepgsql_table_t:s0    |  22 |   2 | /b/b
 system_u:object_r:sepgsql_table_t:s0    | 111 |  11 | /a/a/a
 system_u:object_r:sepgsql_table_t:s0:c1 | 112 |  11 | /a/a/b
 system_u:object_r:sepgsql_table_t:s0    | 113 |  11 | /a/a/c
 system_u:object_r:sepgsql_table_t:s0    | 121 |  12 | /a/b/a
 system_u:object_r:sepgsql_table_t:s0    | 122 |  12 | /a/b/c
(12 rows)

SELECT * FROM h3;
 a |  b  
---+-----
 1 | aaa
 2 | bbb
 3 | ccc
 4 | ddd
 5 | eee
 6 | fff
(6 rows)

SELECT * FROM h4;
 x |  y  
---+-----
 1 | aaa
 2 | bbb
 3 | ccc
 4 | ddd
 5 | eee
 6 | fff
(6 rows)

DROP TABLE h1;
DROP TABLE h2;
DROP TABLE h3;
DROP TABLE h4;
