-- PK/FK constraint test
-- =====================
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

SET client_min_messages TO 'error';
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE IF EXISTS t1 CASCADE;
RESET client_min_messages;
CREATE TABLE t1
(
	x	int primary key,
	y	text
);
psql:sql/constraint.init:19: NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "t1_pkey" for table "t1"
INSERT INTO t1 (security_label, x, y)
       VALUES ('system_u:object_r:sepgsql_table_t:s0',    1, 'aaa'),
       	      ('system_u:object_r:sepgsql_table_t:s0',    2, 'bbb'),
       	      ('system_u:object_r:sepgsql_table_t:s0:c1', 3, 'ccc'),
       	      ('system_u:object_r:sepgsql_table_t:s0:c1', 4, 'ddd');
CREATE TABLE t2
(
	x	int primary key,
	y	text
);
psql:sql/constraint.init:31: NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "t2_pkey" for table "t2"
INSERT INTO t2 (security_label, x, y)
       (SELECT security_label, x, y FROM t1);
CREATE TABLE t3
(
	a	int references t1(x)
);
INSERT INTO t3 (security_label, a)
       VALUES ('system_u:object_r:sepgsql_table_t:s0',    1),
       	      ('system_u:object_r:sepgsql_table_t:s0:c1', 2),
	      ('system_u:object_r:sepgsql_table_t:s0',    3),
	      ('system_u:object_r:sepgsql_table_t:s0:c1', 4);
CREATE TABLE t4
(
	b	int references t2(x)
			ON UPDATE CASCADE ON DELETE SET NULL
);
INSERT INTO t4 (security_label, b)
       VALUES ('system_u:object_r:sepgsql_table_t:s0:c1', 1),
       	      ('system_u:object_r:sepgsql_table_t:s0',    2),
	      ('system_u:object_r:sepgsql_table_t:s0:c1', 3),
	      ('system_u:object_r:sepgsql_table_t:s0',    4);
SELECT security_label, * FROM t1;
             security_label              | x |  y  
-----------------------------------------+---+-----
 system_u:object_r:sepgsql_table_t:s0    | 1 | aaa
 system_u:object_r:sepgsql_table_t:s0    | 2 | bbb
 system_u:object_r:sepgsql_table_t:s0:c1 | 3 | ccc
 system_u:object_r:sepgsql_table_t:s0:c1 | 4 | ddd
(4 rows)

SELECT security_label, * FROM t2;
             security_label              | x |  y  
-----------------------------------------+---+-----
 system_u:object_r:sepgsql_table_t:s0    | 1 | aaa
 system_u:object_r:sepgsql_table_t:s0    | 2 | bbb
 system_u:object_r:sepgsql_table_t:s0:c1 | 3 | ccc
 system_u:object_r:sepgsql_table_t:s0:c1 | 4 | ddd
(4 rows)

SELECT security_label, * FROM t3;
             security_label              | a 
-----------------------------------------+---
 system_u:object_r:sepgsql_table_t:s0    | 1
 system_u:object_r:sepgsql_table_t:s0:c1 | 2
 system_u:object_r:sepgsql_table_t:s0    | 3
 system_u:object_r:sepgsql_table_t:s0:c1 | 4
(4 rows)

SELECT security_label, * FROM t4;
             security_label              | b 
-----------------------------------------+---
 system_u:object_r:sepgsql_table_t:s0:c1 | 1
 system_u:object_r:sepgsql_table_t:s0    | 2
 system_u:object_r:sepgsql_table_t:s0:c1 | 3
 system_u:object_r:sepgsql_table_t:s0    | 4
(4 rows)

-- PK/FK constraint test
-- =====================
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

SELECT security_label, * FROM t1;
            security_label            | x |  y  
--------------------------------------+---+-----
 system_u:object_r:sepgsql_table_t:s0 | 1 | aaa
 system_u:object_r:sepgsql_table_t:s0 | 2 | bbb
(2 rows)

SELECT security_label, * FROM t2;
            security_label            | x |  y  
--------------------------------------+---+-----
 system_u:object_r:sepgsql_table_t:s0 | 1 | aaa
 system_u:object_r:sepgsql_table_t:s0 | 2 | bbb
(2 rows)

SELECT security_label, * FROM t3;
            security_label            | a 
--------------------------------------+---
 system_u:object_r:sepgsql_table_t:s0 | 1
 system_u:object_r:sepgsql_table_t:s0 | 3
(2 rows)

SELECT security_label, * FROM t4;
            security_label            | b 
--------------------------------------+---
 system_u:object_r:sepgsql_table_t:s0 | 2
 system_u:object_r:sepgsql_table_t:s0 | 4
(2 rows)

INSERT INTO t1 VALUES (4, 'ddd');	-- to be failed
psql:sql/constraint.sql:11: ERROR:  duplicate key value violates unique constraint "t1_pkey"
INSERT INTO t1 VALUES (5, 'eee');
INSERT INTO t3 VALUES (2);
INSERT INTO t3 VALUES (3);	-- to be failed
psql:sql/constraint.sql:15: ERROR:  insert or update on table "t3" violates foreign key constraint "t3_a_fkey"
DETAIL:  Key (a)=(3) is not present in table "t1".
DELETE FROM t1 WHERE x = 5 RETURNING *;
 x |  y  
---+-----
 5 | eee
(1 row)

DELETE FROM t1 WHERE x = 2 RETURNING *;	-- to be failed
psql:sql/constraint.sql:18: ERROR:  SELinux: security policy violation
CONTEXT:  SQL statement "SELECT 1 FROM ONLY "public"."t3" x WHERE $1 OPERATOR(pg_catalog.=) "a" FOR SHARE OF x"
UPDATE t2 SET x = x + 10 RETURNING *;	-- to be failed
psql:sql/constraint.sql:20: ERROR:  SELinux: security policy violation
CONTEXT:  SQL statement "UPDATE ONLY "public"."t4" SET "b" = $1 WHERE $2 OPERATOR(pg_catalog.=) "b""
UPDATE t2 SET x = x + 10 WHERE x = 2 RETURNING *;
 x  |  y  
----+-----
 12 | bbb
(1 row)

DELETE FROM t2 WHERE x = 1 RETURNING *;	-- to be failed
psql:sql/constraint.sql:23: ERROR:  SELinux: security policy violation
CONTEXT:  SQL statement "UPDATE ONLY "public"."t4" SET "b" = NULL WHERE $1 OPERATOR(pg_catalog.=) "b""
DELETE FROM t2 WHERE x = 12 RETURNING *;
 x  |  y  
----+-----
 12 | bbb
(1 row)

