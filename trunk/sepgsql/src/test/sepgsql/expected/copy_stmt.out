-- COPY TO/FROM statement
-- ======================
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE IF EXISTS t2 CASCADE;
RESET client_min_messages;
CREATE TABLE t1
(
	a	int,
	b	text
);
COPY t1 (security_label, a, b) FROM stdin;
COPY t1 (security_label, a, b) TO stdout;
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c0	2	bbb
system_u:object_r:sepgsql_table_t:s0:c1	3	ccc
system_u:object_r:sepgsql_table_t:s0	4	ddd
system_u:object_r:sepgsql_table_t:s0:c0	5	eee
system_u:object_r:sepgsql_table_t:s0:c1	6	fff
COPY t1 (security_label, a, b) TO '/tmp/sepgsql_test_copy_1';
COPY t1 (security_label, a, b) TO '/tmp/sepgsql_test_copy_2';
CREATE TABLE t2
(
	x	int,
	y	text
		SECURITY_LABEL = 'system_u:object_r:sepgsql_ro_table_t:s0',
	z	text
		SECURITY_LABEL = 'system_u:object_r:sepgsql_secret_table_t:s0'
);
COPY t2 FROM stdin;
-- COPY TO/FROM statement
-- ======================
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

COPY t1 TO stdout;
1	aaa
2	bbb
4	ddd
5	eee
COPY t2 TO stdout;	-- to be failed
psql:sql/copy_stmt.sql:7: ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.z
COPY t1 (security_label, a, b) TO stdout;
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c0	2	bbb
system_u:object_r:sepgsql_table_t:s0	4	ddd
system_u:object_r:sepgsql_table_t:s0:c0	5	eee
COPY t2 (security_label, x, y) TO stdout;
unconfined_u:object_r:sepgsql_table_t:s0	1	xxx
unconfined_u:object_r:sepgsql_table_t:s0	2	yyy
unconfined_u:object_r:sepgsql_table_t:s0	3	zzz
COPY t2 (security_label, y, z) TO stdout;	-- to be failed
psql:sql/copy_stmt.sql:11: ERROR:  SELinux: denied { select } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_secret_table_t:s0 tclass=db_column name=t2.z
COPY t1 FROM stdin;
COPY t1 (security_label, a, b) FROM stdin;
COPY t2 (security_label, x, y) FROM stdin;	-- to be failed
psql:sql/copy_stmt.sql:21: ERROR:  SELinux: denied { insert } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=system_u:object_r:sepgsql_ro_table_t:s0 tclass=db_column name=t2.y
COPY t1 (security_label, a, b) FROM '/tmp/sepgsql_test_copy_1';	-- to be failed
psql:sql/copy_stmt.sql:23: ERROR:  SELinux: denied { read } scontext=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0 tcontext=unconfined_u:object_r:postgresql_db_t:s0 tclass=file name=/tmp/sepgsql_test_copy_1
COPY t1 (security_label, a, b) FROM '/tmp/sepgsql_test_copy_2';	-- partial success
COPY t1 (security_label, a, b) TO stdout;
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c0	2	bbb
system_u:object_r:sepgsql_table_t:s0	4	ddd
system_u:object_r:sepgsql_table_t:s0:c0	5	eee
unconfined_u:object_r:sepgsql_table_t:s0	98	yyy
unconfined_u:object_r:sepgsql_table_t:s0	99	zzz
system_u:object_r:sepgsql_table_t:s0	97	xxx
system_u:object_r:sepgsql_table_t:s0	1	aaa
system_u:object_r:sepgsql_table_t:s0:c0	2	bbb
system_u:object_r:sepgsql_table_t:s0	4	ddd
system_u:object_r:sepgsql_table_t:s0:c0	5	eee
