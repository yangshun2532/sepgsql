--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS f1(int) CASCADE;
DROP FUNCTION
DROP FUNCTION IF EXISTS f2(int) CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
-- test begins here
CREATE TABLE t1 (
       a     int,
       b     text
);
CREATE TABLE
CREATE TABLE t2 (
       x     int,
       y     text
);
CREATE TABLE
CREATE TABLE t3 (
       s     int,
       t     text
) SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_fixed_table_t:s0';
CREATE TABLE
INSERT INTO t1 VALUES (1, 'aaa');
INSERT 0 1
INSERT INTO t1 (security_label, a, b) VALUES ('unconfined_u:object_r:sepgsql_ro_table_t:s0', 2, 'bbb');
INSERT 0 1
INSERT INTO t1 (security_label, a, b) VALUES ('unconfined_u:object_r:sepgsql_table_t:s0:c1', 3, 'ccc');
INSERT 0 1
INSERT INTO t1 VALUES (4, 'ddd'), (5, 'eee');
INSERT 0 2
INSERT INTO t1 (security_label, a, b) VALUES ('invalid security context', 6, 'fff');	-- to be failed
ERROR:  Not a valid security context: "invalid security context"
INSERT INTO t1 (security_label, a, b) VALUES ('system_u:object_r:sepgsql_table_t:s0:c20', 6, 'fff');	-- to be denied
INSERT 0 0
SELECT security_label, * FROM t1;
               security_label                | a |  b  
---------------------------------------------+---+-----
 unconfined_u:object_r:sepgsql_table_t:s0    | 1 | aaa
 unconfined_u:object_r:sepgsql_ro_table_t:s0 | 2 | bbb
 unconfined_u:object_r:sepgsql_table_t:s0:c1 | 3 | ccc
 unconfined_u:object_r:sepgsql_table_t:s0    | 4 | ddd
 unconfined_u:object_r:sepgsql_table_t:s0    | 5 | eee
(5 rows)

INSERT INTO t2 (security_label, x, y)
       (SELECT sepgsql_set_user(security_label, 'system_u'), a + 5, b || '_cpy' FROM t1);
INSERT 0 5
SELECT security_label, * FROM t2;
             security_label              | x  |    y    
-----------------------------------------+----+---------
 system_u:object_r:sepgsql_table_t:s0    |  6 | aaa_cpy
 system_u:object_r:sepgsql_ro_table_t:s0 |  7 | bbb_cpy
 system_u:object_r:sepgsql_table_t:s0:c1 |  8 | ccc_cpy
 system_u:object_r:sepgsql_table_t:s0    |  9 | ddd_cpy
 system_u:object_r:sepgsql_table_t:s0    | 10 | eee_cpy
(5 rows)

INSERT INTO t3 VALUES (98, 'xxx');
INSERT 0 1
INSERT INTO t3 (security_label, s, t) VALUES ('system_u:object_r:sepgsql_ro_table_t:s0', 99, 'yyy');
INSERT 0 1
INSERT INTO t3 (SELECT * FROM t1);
INSERT 0 5
INSERT INTO t3 (security_label, s, t) (SELECT security_label, x, y FROM t2);
INSERT 0 5
SELECT security_label, * FROM t3;
                 security_label                 | s  |    t    
------------------------------------------------+----+---------
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 | 98 | xxx
 system_u:object_r:sepgsql_ro_table_t:s0        | 99 | yyy
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 |  1 | aaa
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 |  2 | bbb
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 |  3 | ccc
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 |  4 | ddd
 unconfined_u:object_r:sepgsql_fixed_table_t:s0 |  5 | eee
 system_u:object_r:sepgsql_table_t:s0           |  6 | aaa_cpy
 system_u:object_r:sepgsql_ro_table_t:s0        |  7 | bbb_cpy
 system_u:object_r:sepgsql_table_t:s0:c1        |  8 | ccc_cpy
 system_u:object_r:sepgsql_table_t:s0           |  9 | ddd_cpy
 system_u:object_r:sepgsql_table_t:s0           | 10 | eee_cpy
(12 rows)

SELECT sepgsql_set_range(security_label, 's0:c' || s) AS security_label, * INTO t4 FROM t3;	-- partially denied
SELECT
SELECT security_label, * FROM t4;
                  security_label                   | s  |    t    
---------------------------------------------------+----+---------
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c1 |  1 | aaa
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c2 |  2 | bbb
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c3 |  3 | ccc
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c4 |  4 | ddd
 unconfined_u:object_r:sepgsql_fixed_table_t:s0:c5 |  5 | eee
 system_u:object_r:sepgsql_table_t:s0:c6           |  6 | aaa_cpy
 system_u:object_r:sepgsql_ro_table_t:s0:c7        |  7 | bbb_cpy
 system_u:object_r:sepgsql_table_t:s0:c8           |  8 | ccc_cpy
 system_u:object_r:sepgsql_table_t:s0:c9           |  9 | ddd_cpy
 system_u:object_r:sepgsql_table_t:s0:c10          | 10 | eee_cpy
(10 rows)

COPY t1 (security_label, a, b) FROM stdin;	-- partially denied
COPY t1 (security_label, a, b) TO stdout;
unconfined_u:object_r:sepgsql_table_t:s0	1	aaa
unconfined_u:object_r:sepgsql_ro_table_t:s0	2	bbb
unconfined_u:object_r:sepgsql_table_t:s0:c1	3	ccc
unconfined_u:object_r:sepgsql_table_t:s0	4	ddd
unconfined_u:object_r:sepgsql_table_t:s0	5	eee
system_u:object_r:sepgsql_table_t:s0:c2	10	kkk
system_u:object_r:sepgsql_table_t:s0:c3	11	lll
system_u:object_r:sepgsql_table_t:s0:c4	13	nnn
