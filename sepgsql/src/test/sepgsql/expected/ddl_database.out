--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SET sepostgresql_mcstrans TO off;
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
DROP DATABASE IF EXISTS sepgsql_regress_db_1;
DROP DATABASE IF EXISTS sepgsql_regress_db_2;
DROP DATABASE IF EXISTS sepgsql_regress_db_3;
DROP DATABASE IF EXISTS sepgsql_regress_db_4;
RESET client_min_messages;
-- CREATE DATABASE with SECURITY_CONTEXT option
CREATE DATABASE sepgsql_regress_db_1;
CREATE DATABASE sepgsql_regress_db_2
       SECURITY_CONTEXT = 'system_u:object_r:sepgsql_db_t:s0:c0';
CREATE DATABASE sepgsql_regress_db_3
       SECURITY_CONTEXT = 'system_u:object_r:sepgsql_db_t:s0:c16';	-- to be denied
ERROR:  SELinux: security policy violation
CREATE DATABASE sepgsql_regress_db_4
       SECURITY_CONTEXT = 'invalid security context';			-- to be failed
ERROR:  invalid security context "invalid security context"
SELECT datname, sepgsql_database_getcon(oid), datsecon FROM pg_database
       WHERE datname like 'sepgsql_regress_db_%';
       datname        |        sepgsql_database_getcon        |               datsecon                
----------------------+---------------------------------------+---------------------------------------
 sepgsql_regress_db_1 | unconfined_u:object_r:sepgsql_db_t:s0 | unconfined_u:object_r:sepgsql_db_t:s0
 sepgsql_regress_db_2 | system_u:object_r:sepgsql_db_t:s0:c0  | system_u:object_r:sepgsql_db_t:s0:c0
(2 rows)

-- ALTER DATABASE with SECURITY_CONTEXT option
ALTER DATABASE sepgsql_regress_db_1
      SECURITY_CONTEXT TO 'system_u:object_r:sepgsql_db_t:s0:c1';
ALTER DATABASE sepgsql_regress_db_1
      SECURITY_CONTEXT TO 'system_u:object_r:sepgsql_db_t:s0:c20';	-- to be deined
ERROR:  SELinux: security policy violation
ALTER DATABASE sepgsql_regress_db_2
      SECURITY_CONTEXT TO 'invalid security context';			-- to be failed
ERROR:  invalid security context "invalid security context"
ALTER DATABASE sepgsql_regress_db_3
      SECURITY_CONTEXT TO 'system_u:object_r:sepgsql_db_t:s0:c2';	-- no such database
ERROR:  database "sepgsql_regress_db_3" does not exist
SELECT datname, sepgsql_database_getcon(oid), datsecon FROM pg_database
       WHERE datname like 'sepgsql_regress_db_%';
       datname        |       sepgsql_database_getcon        |               datsecon               
----------------------+--------------------------------------+--------------------------------------
 sepgsql_regress_db_2 | system_u:object_r:sepgsql_db_t:s0:c0 | system_u:object_r:sepgsql_db_t:s0:c0
 sepgsql_regress_db_1 | system_u:object_r:sepgsql_db_t:s0:c1 | system_u:object_r:sepgsql_db_t:s0:c1
(2 rows)

-- disallow to modify system catalog by hand
UPDATE pg_database SET datsecon = NULL
       WHERE datname like 'sepgsql_regress_db_%';			-- to be failed
ERROR:  SE-PgSQL prevents to modify "pg_database" by hand
-- cleanups
SET client_min_messages TO 'error';
DROP DATABASE IF EXISTS sepgsql_regress_db_1;
DROP DATABASE IF EXISTS sepgsql_regress_db_2;
DROP DATABASE IF EXISTS sepgsql_regress_db_3;
DROP DATABASE IF EXISTS sepgsql_regress_db_4;
RESET client_min_messages;
