--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS f1(int,int) CASCADE;
DROP FUNCTION
DROP FUNCTION IF EXISTS f2(int,int) CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
-- CREATE TABLE with SECURITY_LABEL clause
CREATE TABLE t1 (
       a int,
       b text
);
CREATE TABLE
SELECT sepgsql_table_getcon('t1');
           sepgsql_table_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t1', 'a');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t1', 'b');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

CREATE TABLE t2 (
       a int,
       b text
) SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_ro_table_t:s0';
CREATE TABLE
SELECT sepgsql_table_getcon('t2');
            sepgsql_table_getcon             
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t2', 'a');
            sepgsql_column_getcon            
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t2', 'b');
            sepgsql_column_getcon            
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

CREATE TABLE t3 (
       a int,
       b text SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_fixed_table_t:s0',
       c bool SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_secret_table_t:s0',
       d int
) SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_table_t:s0:c0';
CREATE TABLE
SELECT sepgsql_table_getcon('t3');
            sepgsql_table_getcon             
---------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0:c0
(1 row)

SELECT sepgsql_column_getcon('t3', 'a');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t3', 'b');
             sepgsql_column_getcon              
------------------------------------------------
 unconfined_u:object_r:sepgsql_fixed_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t3', 'c');
              sepgsql_column_getcon              
-------------------------------------------------
 unconfined_u:object_r:sepgsql_secret_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t3', 'd');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

CREATE TABLE t4 (
       a int,
       b text
) SECURITY_LABEL = 'unconfined_u:object_r:invalid_label_t:s0';	-- to be failed
ERROR:  SELinux: invalid security label: unconfined_u:object_r:invalid_label_t:s0
CREATE TABLE t4 (
       a int,
       b text
) SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_proc_t:s0';	-- to be denied
ERROR:  SELinux: denied { create } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=unconfined_u:object_r:sepgsql_proc_t:s0 tclass=db_table name=t4
-- ALTER TABLE with SECURITY_LABEL clause
ALTER TABLE t2 SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_ro_table_t:s0';
ALTER TABLE
ALTER TABLE t2 ADD COLUMN c bool;
ALTER TABLE
SELECT sepgsql_table_getcon('t2');
            sepgsql_table_getcon             
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t2', 'a');	-- keep previous setting
            sepgsql_column_getcon            
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t2', 'c');	-- new column inherits table's one
            sepgsql_column_getcon            
---------------------------------------------
 unconfined_u:object_r:sepgsql_ro_table_t:s0
(1 row)

ALTER TABLE t3 ALTER b SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_table_t:s0';
ALTER TABLE
SELECT sepgsql_table_getcon('t3');
            sepgsql_table_getcon             
---------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0:c0
(1 row)

SELECT sepgsql_column_getcon('t3', 'a');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

SELECT sepgsql_column_getcon('t3', 'b');
          sepgsql_column_getcon           
------------------------------------------
 unconfined_u:object_r:sepgsql_table_t:s0
(1 row)

-- CREATE FUNCTION with SECURITY_LABEL clause
CREATE FUNCTION f1 (int, int) RETURNS int
       LANGUAGE 'sql'
       SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_proc_t:s0:c0'
       AS 'SELECT $1 + $2';
CREATE FUNCTION
SELECT sepgsql_procedure_getcon('f1');
          sepgsql_procedure_getcon          
--------------------------------------------
 unconfined_u:object_r:sepgsql_proc_t:s0:c0
(1 row)

CREATE FUNCTION f2 (int, int) RETURNS int
       LANGUAGE 'sql'
       SECURITY_LABEL = 'unconfined_u:object_r:invalid_label_t:s0'
       AS 'SELECT $1 - $2';	 -- to be failed
ERROR:  SELinux: invalid security label: unconfined_u:object_r:invalid_label_t:s0
CREATE FUNCTION f2 (int, int) RETURNS int
       LANGUAGE 'sql'
       SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_proc_t:s0:c16'
       AS 'SELECT $1 - $2';	 -- to be denied
ERROR:  SELinux: denied { create } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=unconfined_u:object_r:sepgsql_proc_t:s0:c16 tclass=db_procedure name=f2
CREATE FUNCTION f2 (int, int) RETURNS int
       LANGUAGE 'sql'
       AS 'SELECT $1 - $2';
CREATE FUNCTION
SELECT sepgsql_procedure_getcon('f2');
        sepgsql_procedure_getcon         
-----------------------------------------
 unconfined_u:object_r:sepgsql_proc_t:s0
(1 row)

-- ALTER FUNCTION with SECURITY_LABEL clause
ALTER FUNCTION f1(int, int)
      SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_proc_t:s0:c1';
ALTER FUNCTION
SELECT sepgsql_procedure_getcon('f1');
          sepgsql_procedure_getcon          
--------------------------------------------
 unconfined_u:object_r:sepgsql_proc_t:s0:c1
(1 row)

ALTER FUNCTION f2(int, int)
      SECURITY_LABEL = 'unconfined_u:object_r:sepgsql_proc_t:s0:c16';	-- to be denied
ERROR:  SELinux: denied { relabelto } scontext=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15 tcontext=unconfined_u:object_r:sepgsql_proc_t:s0:c16 tclass=db_procedure name=f2
SELECT sepgsql_procedure_getcon('f2');
        sepgsql_procedure_getcon         
-----------------------------------------
 unconfined_u:object_r:sepgsql_proc_t:s0
(1 row)

