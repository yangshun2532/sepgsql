--@SECURITY_CONTEXT=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
SELECT sepgsql_getcon();
                   sepgsql_getcon                    
-----------------------------------------------------
 unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c15
(1 row)

-- cleanup previous tests
SET client_min_messages TO 'error';
SET
DROP TABLE IF EXISTS t1 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t2 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t3 CASCADE;
DROP TABLE
DROP TABLE IF EXISTS t4 CASCADE;
DROP TABLE
DROP FUNCTION IF EXISTS f1(int) CASCADE;
DROP FUNCTION
RESET client_min_messages;
RESET
-- SETUP
CREATE TABLE t1
(
    a   int,
    b   int
        SECURITY_LABEL = 'system_u:object_r:sepgsql_fixed_table_t:s0',
    c   int
        SECURITY_LABEL = 'system_u:object_r:sepgsql_ro_table_t:s0',
    d   int
        SECURITY_LABEL = 'system_u:object_r:sepgsql_secret_table_t:s0'
);
CREATE TABLE
INSERT INTO t1 VALUES (1,2,3,4), (5,6,7,8);
INSERT 0 2
CREATE TABLE t2
(
    x   int,
    y   int
) SECURITY_LABEL = 'system_u:object_r:sepgsql_table_t:s0:c0';
CREATE TABLE
CREATE TABLE t3
(
    z   int
) SECURITY_LABEL = 'system_u:object_r:sepgsql_table_t:s0:c1';
CREATE TABLE
CREATE TABLE t4
(
    a   int primary key,
    b   text
        SECURITY_LABEL = 'system_u:object_r:sepgsql_secret_table_t:s0'
);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "t4_pkey" for table "t4"
CREATE TABLE
INSERT INTO t4 VALUES (1, '1111-2222-3333-4444'),
                      (2, '5555-6666-7777-8888');
INSERT 0 2
CREATE OR REPLACE FUNCTION f1(int) RETURNS TEXT
    LANGUAGE 'sql'
    SECURITY_LABEL = 'system_u:object_r:sepgsql_trusted_proc_exec_t:s0'
    AS 'SELECT regexp_replace(b, ''-[0-9]+'', ''-xxxx'',''g'') FROM t4 WHERE a = $1';
CREATE FUNCTION
SELECT * FROM t1;
 a | b | c | d 
---+---+---+---
 1 | 2 | 3 | 4
 5 | 6 | 7 | 8
(2 rows)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c0
(1 row)

SELECT * FROM t1;		-- to be denied
ERROR:  SELinux: security policy violation
SELECT t1 FROM t1;		-- to be denied
ERROR:  SELinux: security policy violation
SELECT a,b,c FROM t1;
 a | b | c 
---+---+---
 1 | 2 | 3
 5 | 6 | 7
(2 rows)

SELECT a,b,c FROM t1 FOR UPDATE;
 a | b | c 
---+---+---
 1 | 2 | 3
 5 | 6 | 7
(2 rows)

INSERT INTO t1 (a,b,c,d) VALUES (3,3,3,3);	-- to be denied
ERROR:  SELinux: security policy violation
INSERT INTO t1 (a,b,c) VALUES (4,4,4);		-- to be denied
ERROR:  SELinux: security policy violation
INSERT INTO t1 (a,b) VALUES (5,5);
INSERT 0 1
SELECT a,b,c FROM t1;
 a | b | c 
---+---+---
 1 | 2 | 3
 5 | 6 | 7
 5 | 5 |  
(3 rows)

UPDATE t1 SET a=6, b=6, c=6, d=6;		-- to be denied
ERROR:  SELinux: security policy violation
UPDATE t1 SET a=6, b=6, c=6;			-- to be denied
ERROR:  SELinux: security policy violation
UPDATE t1 SET a=6, b=6;				-- to be denied
ERROR:  SELinux: security policy violation
UPDATE t1 SET a=6;
UPDATE 3
SELECT a,b,c FROM t1;
 a | b | c 
---+---+---
 6 | 2 | 3
 6 | 6 | 7
 6 | 5 |  
(3 rows)

SELECT * FROM t2;
 x | y 
---+---
(0 rows)

SELECT * FROM t3;		-- to be denied
ERROR:  SELinux: security policy violation
SELECT 1 FROM t3;		-- to be denied
ERROR:  SELinux: security policy violation
SELECT count(*) FROM t3;	-- to be denied
ERROR:  SELinux: security policy violation
SELECT * FROM t4;	-- to be denied
ERROR:  SELinux: security policy violation
SELECT a, f1(a) FROM t4;
 a |         f1          
---+---------------------
 1 | 1111-xxxx-xxxx-xxxx
 2 | 5555-xxxx-xxxx-xxxx
(2 rows)

--@SECURITY_CONTEXT=unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1
SELECT sepgsql_getcon();
                  sepgsql_getcon                   
---------------------------------------------------
 unconfined_u:unconfined_r:sepgsql_test_t:s0-s0:c1
(1 row)

SELECT * FROM t2;	-- to be denied
ERROR:  SELinux: security policy violation
SELECT t2 FROM t2;	-- to be denied
ERROR:  SELinux: security policy violation
SELECT t3 FROM t3;
 t3 
----
(0 rows)

